<div x-data="alpineOperations()" x-init="getOperations()" xmlns="http://www.w3.org/1999/html">
    <div>
        <div>
            <div>
                <h2>Operations</h2>
                <p>
                    Start a new operation or review previous ones here.
                </p>
            </div>
            <hr>
        </div>
        <!--        <div class="columns">-->
        <div>
            <div class="is-flex-direction-column">
                <div class="columns">
                    <div class="column is-flex is-one-quarter is-justify-content-space-between is-flex-direction-column">
                        <label for="op-search">Search operations:</label>
                        <div class="is-flex is-align-items-center">
                            <i class="fas fa-search"></i>
                            <input id="op-search" placeholder="Operation name:">
                            <i class="fas fa-close"></i>
                        </div>
                    </div>
                    <div class="column pl-0 is-flex is-align-items-flex-end">
                        <button type="button" title="delete operation" class="button is-primary is-small"
                                x-on:click="deleteOperation()"><i class="pr-1 fas fa-trash"></i></button>
                        <button title="download event logs" class="button is-primary is-small ml-2"
                                x-on:click="openModal = 'showDownloadMenu'"><i class="pr-1 fas fa-arrow-down"></i>
                        </button>
                        <button type="button" title="add operation" class="ml-2 button is-primary is-small"
                                x-on:click="openModal = 'addOperation'"><i class="pr-1 fas fa-plus"></i>
                            Add new operation
                        </button>
                        <!--                        TODO add modal to download button-->
                        <!--                        <div class="column is-flex is-align-items-flex-end is-flex-direction-column">-->
                        <!--                            <div class="mr-2">-->
                        <!--                                <input id="agent-output" type="checkbox" x-model="isAgentOutputSelected">-->
                        <!--                                <label class="pl-1 is-small" for="agent-output">include agent output</label>-->
                        <!--                            </div>-->
                        <!--                            <div class="is-flex mt-2">-->
                        <!--                                <button title="download full report" class="button is-primary is-small ml-2"-->
                        <!--                                        x-on:click="downloadInfo('full-report')"><i class="pr-1 fas fa-arrow-down"></i>Full-->
                        <!--                                    report-->
                        <!--                                </button>-->
                        <!--                                <button title="download event logs" class="button is-primary is-small ml-2"-->
                        <!--                                        x-on:click="downloadInfo('event-logs')"><i class="pr-1 fas fa-arrow-down"></i>Event-->
                        <!--                                    logs-->
                        <!--                                </button>-->
                        <!--                            </div>-->
                        <!--                        </div>-->
                    </div>
                </div>
                <div class="is-flex is-flex-direction-row is-justify-content-flex-start">
                    <template x-for="op in operations">
                        <button class="no-style operation-menu-links mr-2"
                                :key="op.id"
                                x-on:click="selectedOperationID = op.id; getOperation()">
                            <i class="fas fa-cog"></i>
                            <!--                            <i style="position: relative;left: -32px;top: -8px;" class="fas fa-folder"><span x-text="op.chain?.length"></span></i>-->
                            <span x-text="op.name"></span>
                            <span class="readable-time" x-text="getHumanFriendlyTime(op.start)"></span>
                        </button>
                    </template>
                </div>
            </div>


            <div class="">
                <template x-if="selectedOperation">
                    <div x-show="selectedOperationID">
                        <div class="navbar-divider"></div>
                        <div class="columns">
                            <div class="column is-flex is-flex-direction-column is-justify-content-center">
                                <div class="is-flex is-flex-direction-row is-justify-content-center mt-2 ml-5">
                                    <div class="mr-6">
                                        <h3 class="my-1 is-size-4" x-text="selectedOperation.name"></h3>
                                        <h2 class="is-size-6 has-text-weight-normal mb-5 mt-0">Operation</h2>
                                    </div>
                                    <div class="mr-6">
                                        <h3 class="my-1 is-size-5" x-text="selectedOperation.state"></h3>
                                        <h2 class="is-size-7 has-text-weight-normal mb-5 mt-0">Current state</h2>
                                    </div>
                                    <div class="mr-6">
                                        <h3 class="my-1 is-size-5" x-text="selectedOperation.chain.length"></h3>
                                        <h2 class="is-size-7 has-text-weight-normal mb-5 mt-0">Decisions</h2>
                                    </div>
                                </div>
                                <div class="controls-container is-flex is-justify-content-center is-align-items-center">
                                    <button class="button no-style is-large"
                                            x-on:click="updateOperationState('cleanup')"><i
                                            alt="stop" class="fas fa-stop"></i></button>
                                    <template x-if="selectedOperation.state ==='running'">
                                        <button class="button no-style is-larger"
                                                x-on:click="updateOperationState('paused')"><i
                                                alt="pause" class="fas fa-pause-circle"></i></button>
                                    </template>
                                    <template x-if="selectedOperation.state !== 'running'">
                                        <button class="button no-style is-larger"
                                                x-on:click="updateOperationState('running')">
                                            <i alt="run" class="fas fa-play-circle"></i></button>
                                    </template>
                                    <button class="button no-style is-medium"
                                            x-on:click="updateOperationState('run_one_link')">
                                        <i alt="run one step" class="fas fa-play"><sub>1</sub></i></button>
                                </div>
                            </div>

                            <div class="column is-flex is-flex-direction-column is-flex-wrap-wrap is-align-items-flex-end">
                                <div>
                                    <label for="operation-obfuscator"></label>
                                    Obfuscation method:
                                    </label>
                                    <div class="is-flex is-flex-direction-row is-flex-wrap-wrap"
                                         id="operation-obfuscator">
                                        {% for o in obfuscators %}
                                        <button x-bind:class="selectedOperation.obfuscator === `{{ o.name|e }}` ? 'selected' : ''"
                                                class="no-style chip-select"
                                                x-on:click="updateObfuscator(`{{ o.name|e }}`)">
                                            {{ o.name|e }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="toggleContainer my-3">
                                    <label class="toggleSwitch" for="toggleAutonomous">
                                        <input type="checkbox" id="toggleAutonomous"
                                               x-model="selectedOperation.autonomous"
                                               x-bind:checked="Boolean(selectedOperation.autonomous) ? 'checked' : null"
                                               x-on:change="updateOperationToggle()"/>
                                        <span class="toggleSlider toggleSliderRound"
                                              x-bind:class="Boolean(selectedOperation.autonomous) ? 'toggle-on' : 'toggle-off'">
                                                <span x-bind:class="Boolean(selectedOperation.autonomous) ? 'toggle-slider-on' : 'toggle-slider-off'"
                                                      x-text="Boolean(selectedOperation.autonomous) ? 'Autonomous' : 'Manual'"></span>
                                            </span>
                                    </label>
                                </div>


                                <div class="my-3">
                                    <button title="add manual command" class="button is-primary is-small ml-2"
                                            x-on:click="openModal = 'addCommand'">Add manual command
                                    </button>
                                    <button title="add potential link" class="button is-primary is-small ml-2"
                                            x-on:click="openModal = 'addLink'">Add potential link
                                    </button>
                                </div>

                            </div>
                        </div>

                        <div class="log-container">
                            <template x-if="selectedOperation.chain">
                                <table class="table">
                                    <thead>
                                    <tr class="table-header">
                                        <th class="decideColumn">Decide / Status</th>
                                        <th title="Link Status Indicator"></th>
                                        <th>Link Information</th>
                                        <!--                                        <th>Agent</th>-->
                                        <th title="Link Details"></th>
                                    </tr>
                                    </thead>
                                    <template x-for="(link, index) in selectedOperation.chain">
                                        <tbody :key="index">
                                        <tr x-bind:id="link.id" class="success">
                                            <td class="decideColumn">
                                                <span x-text="link.decide"></span>
                                                <span x-text="(link.status in linkStatuses) ? linkStatuses[link.status] : 'queued'"></span>
                                            </td>
                                            <td class="linkStatusColumn">
                                                <span x-bind:title="(link.status in linkStatuses) ? linkStatuses[link.status] : 'queued'"
                                                      x-bind:class="'linkStatus status-'+((link.status in linkStatuses) ? linkStatuses[link.status] : 'queued')"></span>
                                            </td>
                                            <td x-text="link.ability.name + ((link.ability.cleanup) ? '(CLEANUP)' : '') + ' run on agent #'+link.paw"></td>
                                            <!--                                            <td x-text="'agent#'+link.paw">-->
                                            <td x-show="false" class="linkActionsColumn">
                                                <span>
                                                    <template x-if="link.facts.length > 0">
                                                        <button title="show facts" class="button no-style"
                                                                x-on:click="selectedLink = link; getResults(link.id); openModal = 'showFacts'">
                                                            <i class="fas fa-star facts"></i>
                                                        </button>
                                                    </template>
                                                    <template x-if="link.facts.length < 1">
                                                        <button disabled class="button no-style" title="no facts"><i
                                                                class="far fa-star no-facts"></i></button>
                                                    </template>
                                                </span>
                                                <span>
                                                    <template x-if="link.status === -5">
                                                        <button title="remove link" class="button no-style"
                                                                x-on:click="updateLinkState(link.id, -3)"><i
                                                                class="fas fa-plus"></i></button>
                                                    </template>
                                                    <template
                                                            x-if="!(link.collect || link.status <= -4) || link.status === -1">
                                                        <button title="remove link" class="button no-style"
                                                                x-on:click="updateLinkState(link.id, -2)"><i
                                                                class="fas fa-trash"></i></button>
                                                        </button>
                                                    </template>
                                                </span>
                                                <template x-if="link.status === -1">
                                                    <span x-bind:class="'editButtonContainer ' + (showLinkEditDropdown === link.id ? 'selected' : '') ">
                                                        <button title="edit command" class="button no-style"
                                                                x-on:click="showLinkEditDropdown = (showLinkEditDropdown === link.id) ? null : link.id"><i
                                                                x-bind:class="(showLinkEditDropdown === link.id) ? 'expanded' : 'collapsed'"
                                                                class="fas fa-pencil-alt editCommand"></i></button>
                                                    </span>
                                                </template>
                                            </td>
                                        </tr>
                                        <tr x-show="false" class="linkEditCommandRow"
                                            x-show="showLinkEditDropdown === link.id">
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td x-init="editedCommand = editedCommand ? editedCommand : b64DecodeUnicode(link.command)">
                                                <label for="editedCommand"></label>
                                                <textarea id="editedCommand"
                                                          class="code"
                                                          contenteditable
                                                          x-model="editedCommand"
                                                          spellcheck="false"></textarea>
                                                <div class="linkEditControls">
                                                    <button class="button is-primary is-small"
                                                            x-on:click="updateLinkState(link.id, -3, editedCommand); showLinkEditDropdown = null">
                                                        Update
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </template>
                                </table>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

        </div>

        <!--    MODALS      -->
        <template x-if="openModal">
            <div class="modal is-active">
                <div class="modal-background"></div>
                <form class="m-1">
                    <div class="modal-card">
                        <template x-if="openModal === 'addOperation'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Start New Operation</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="op-name">Operation name:</label>
                                            <div class="modal-form-fields">
                                                <input class="input" id="op-name" type="text"
                                                       x-model="startOperation.name" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-form-group-header">
                                        <button type="button" class="button no-style heading pt-2"
                                                x-on:click="openModalForm.basic = !openModalForm.basic"
                                                x-bind:class="openModalForm.basic ? 'expanded' : 'collapsed'">
                                            <span>Basic options</span>
                                            <span class="navbar-divider"></span>
                                        </button>
                                    </div>
                                    <div class="modal-form" x-show="openModalForm.basic">
                                        <div>
                                            <label for="basic-groups">Groups:</label>
                                            <div class="modal-form-fields" id="basic-groups">
                                                <span>
                                                    <input id="all-groups" value="" type="radio"
                                                           x-model="startOperation.group" checked>
                                                    <label for="all-groups">Use all groups</label>
                                                </span>
                                                <template x-for="(group, index) in agentGroups">
                                                    <span>
                                                        <input x-bind:id="index" type="radio" x-bind:value="group"
                                                               x-model="startOperation.group">
                                                        <label x-bind:for="index" x-text="group"></label>
                                                    </span>
                                                </template>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="basic-adversary">Adversary:</label>
                                            <div class="modal-form-fields" id="basic-adversary">
                                                <select x-model="startOperation.adversary_id">
                                                    <option value="" selected>No adversary (manual)</option>
                                                    {% for adv in adversaries %}
                                                    {% if adv.has_repeatable_abilities %}
                                                    <option id="qflow-{{ adv.adversary_id|e }}"
                                                            value="{{ adv.adversary_id|e }}">
                                                        {{ adv.name|e }}
                                                    </option>
                                                    {% else %}
                                                    <option id="qflow-{{ adv.adversary_id|e }}"
                                                            value="{{ adv.adversary_id|e }}">{{
                                                        adv.name|e }}
                                                    </option>
                                                    {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="basic-keep">Keep:</label>
                                            <div class="modal-form-fields" id="basic-keep">
                                                <input type="radio" id="keep-open"
                                                       x-model="startOperation.auto_close"
                                                       value="0" checked>
                                                <label for="keep-open">Keep open forever</label>
                                                <input type="radio" id="auto-close"
                                                       x-model="startOperation.auto_close"
                                                       value="1">
                                                <label for="auto-close">Auto close operation</label>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="basic-run">Run:</label>

                                            <div class="modal-form-fields" id="basic-run">
                                                <input type="radio" x-model="startOperation.state"
                                                       id="run-immediately"
                                                       value="running" checked>
                                                <label for="run-immediately">Run immediately</label>
                                                <input type="radio" x-model="startOperation.state"
                                                       id="pause-on-start"
                                                       value="paused">
                                                <label for="pause-on-start">Pause on start</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-form-group-header">
                                        <button type="button" class="button no-style heading pt-2"
                                                x-on:click="openModalForm.autonomous = !openModalForm.autonomous"
                                                x-bind:class="openModalForm.autonomous ? 'expanded' : 'collapsed'">
                                            <span>Autonomous</span>
                                            <span class="navbar-divider"></span>
                                        </button>
                                    </div>
                                    <div class="modal-form" x-show="openModalForm.autonomous">
                                        <div>
                                            <label for="autonomous-autonomous">Autonomous:</label>
                                            <div class="modal-form-fields" id="autonomous-autonomous">
                                                <input type="radio" id="run-autonomously"
                                                       x-model="startOperation.autonomous" value="1" checked>
                                                <label for="run-autonomously">Run autonomously</label>
                                                <input type="radio" id="manual-approval"
                                                       x-model="startOperation.autonomous" value="0">
                                                <label for="manual-approval">Require manual approval</label>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="autonomous-planner">Planner:</label>
                                            <div class="modal-form-fields" id="autonomous-planner">
                                                {% for p in planners %}
                                                {% if p.name == "atomic" %}
                                                <input type="radio" id="{{ p.name|e }}" x-model="startOperation.planner"
                                                       value="{{ p.name|e }}"
                                                       checked>
                                                <label for="{{ p.name|e }}">{{ p.name|e }}</label>
                                                {% elif p.allow_repeatable_abilities %}
                                                <input type="radio" id="{{ p.name|e }}"
                                                       value="{{ p.name|e }}"
                                                       x-model="startOperation.planner">
                                                <label for="{{ p.name|e }}">{{ p.name|e }}</label>
                                                {% else %}
                                                <input type="radio" id="{{ p.name|e }}"
                                                       value="{{ p.name|e }}"
                                                       x-model="startOperation.planner">
                                                <label for="{{ p.name|e }}">{{ p.name|e }}</label>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div>
                                            <label for="autonomous-source">Source:</label>
                                            <div class="modal-form-fields" id="autonomous-source">
                                                {% for s in sources %}
                                                {% if loop.first %}
                                                <input type="radio" value="{{ s.name|e }}" id="{{ s.name|e }}"
                                                       x-model="startOperation.source"
                                                       checked>
                                                <label for="{{ s.name|e }}">{{ s.name|e
                                                    }}</label>
                                                {% else %}
                                                <input type="radio" value="{{ s.name|e }}" id="{{ s.name|e }}"
                                                       x-model="startOperation.source">
                                                <label for="{{ s.name|e }}">{{ s.name|e
                                                    }}</label>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div>
                                            <label for="autonomous-use_learning_parsers">Parser:</label>
                                            <div class="modal-form-fields" id="autonomous-use_learning_parsers">
                                                <input type="radio" id="parsers-default"
                                                       x-model="startOperation.use_learning_parsers" value="1" checked>
                                                <label for="parsers-default">Use default parsers</label>
                                                <input type="radio" id="parsers-no_default"
                                                       x-model="startOperation.use_learning_parsers" value="0">
                                                <label for="parsers-no_default">Do not use default parsers</label>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="autonomous-cleanup_timeout">Cleanup Timeout (secs):</label>
                                            <div class="modal-form-fields" id="autonomous-cleanup_timeout">
                                                <input class="input" x-model="startOperation.timeout" type="number"
                                                       placeholder="30" value="30" min="0" max="300"
                                                       onchange="toast('The number of seconds Caldera will wait per cleanup action to complete before continuing.')">
                                            </div>
                                        </div>
                                    </div>


                                    <div class="modal-form-group-header">
                                        <button type="button" class="button no-style heading pt-2"
                                                x-on:click="openModalForm.stealth = !openModalForm.stealth"
                                                x-bind:class="openModalForm.stealth ? 'expanded' : 'collapsed'">
                                            <span>Stealth</span>
                                            <span class="navbar-divider"></span>
                                        </button>
                                    </div>
                                    <div class="modal-form" x-show="openModalForm.stealth">
                                        <div>
                                            <label for="stealth-obfuscator">Obfuscator:</label>
                                            <div class="modal-form-fields" id="stealth-obfuscator">
                                                <select x-model="startOperation.obfuscator">
                                                    {% for o in obfuscators %}
                                                    {% if loop.first %}
                                                    <option value="{{ o.name|e }}" selected>{{ o.name|e }}
                                                        obfuscation
                                                    </option>
                                                    {% else %}
                                                    <option value="{{ o.name|e }}">{{ o.name|e }} obfuscation
                                                    </option>
                                                    {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="stealth-jitter">Jitter (min/max) sec:</label>
                                            <div class="modal-form-fields">
                                                <input class="input" x-model="startOperation.jitter"
                                                       id="stealth-jitter" value="4/8" type="text"
                                                       required
                                                       pattern="[0-9\/0-9]*"
                                                       placeholder="4/8"/>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="stealth-queue">Adjust visibility:</label>
                                            <div class="modal-form-fields">
                                                <input x-model="startOperation.visibility"
                                                       id="stealth-queue"
                                                       type="range" value="50" min="1" max="100"
                                                       onchange="toast('The higher the visibility number, the more risk you will take with your operation getting noticed by the defense.')">
                                                <span x-text="startOperation.visibility"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-form-group-header">
                                        <button type="button" class="button no-style heading pt-2"
                                                x-on:click="openModalForm.schedule = !openModalForm.schedule"
                                                x-bind:class="openModalForm.schedule ? 'expanded' : 'collapsed'">
                                            <span>Schedule</span>
                                            <span class="navbar-divider"></span>
                                        </button>
                                    </div>
                                    <div class="modal-form" x-show="openModalForm.schedule">
                                        <div>
                                            <label for="schedule-schedule">Schedule operation:</label>
                                            <div class="modal-form-fields">
                                                <input class="input" x-model="schedule"
                                                       type="time"
                                                       id="schedule-schedule" value="00:00">
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'addCommand'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Add New Manual Command</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="manual-agent">Choose an agent:</label>
                                            <div class="modal-form-fields">
                                                <select id="manual-agent" x-model="selectedAgentIndex">
                                                    <option default>none selected</option>
                                                    <template x-for="(agent, index) in selectedOperation.host_group">
                                                        <option :value="index"
                                                                x-text="agent.display_name + '-' + agent.paw"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                        <template x-if="selectedAgent">
                                            <div>
                                                <label for="input-command">Type manual command:</label>
                                                <div class="modal-form-fields">
                                                    <div class="modal-form-fields-columns">
                                                        <select x-model="manualCommand.executor" id="manual-executor"
                                                                class="column executor-selector">
                                                            <template
                                                                    x-for="(executor, index) in selectedAgentExecutors">
                                                                <option x-text="executor"
                                                                        :value="selectedAgent.executors[index]"
                                                                        x-bind:selected="index === 0"></option>
                                                            </template>
                                                        </select>
                                                        <input x-model="manualCommand.command"
                                                               class="column input executor-command"
                                                               id="input-command"
                                                               type="text"
                                                               required
                                                               placeholder="Echo 'Hello World!'">
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'addLink'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Add New Potential Link</p>
                                </header>
                                <section class="modal-card-body">
                                    <div class="modal-form">
                                        <div>
                                            <label for="link-agent">Agent:</label>
                                            <div class="modal-form-fields">
                                                <select id="link-agent"
                                                        x-model="selectedAgentIndex"
                                                        x-on:change="getAgentLinks()">
                                                    <option default value="">Choose an agent...</option>
                                                    <template x-for="(agent, index) in selectedOperation.host_group">
                                                        <option :value="index"
                                                                x-text="agent.display_name + '-' + agent.paw"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="link-tactic">Tactic:</label>
                                            <div class="modal-form-fields">
                                                <select id="link-tactic"
                                                        x-model="potentialLink.tactic"
                                                        x-on:change="filterAbilities()">
                                                    <option default value="">Choose a tactic...</option>
                                                    <template x-for="tactic in tacticFiltersList">
                                                        <option x-text="tactic"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="link-technique">Technique:</label>
                                            <div class="modal-form-fields">
                                                <select id="link-technique"
                                                        x-model="potentialLink.technique"
                                                        x-on:change="filterAbilities()">
                                                    <option default>Choose a technique...</option>
                                                    <template x-for="technique in techniqueFiltersList">
                                                        <option x-text="technique"></option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-results">
                                        <div class="navbar-divider"></div>
                                        <p class="is-flex is-justify-content-flex-end is-size-7"
                                           x-text="filteredLinksList.length + ' potential link' + ((filteredLinksList.length === 1) ? '' : 's')"></p>
                                        <template x-if="filteredLinksList">
                                            <ul>
                                                <template x-for="link in filteredLinksList">
                                                    <li>
                                                        <p x-text="link.ability.name"></p>
                                                        <button class="button is-primary is-small"
                                                                x-on:click="addLink(link)">
                                                            Add Link
                                                        </button>
                                                    </li>
                                                </template>
                                            </ul>
                                        </template>
                                        <template x-if="!filteredLinksList"><p>Building potential links...</p>
                                        </template>
                                    </div>
                                </section>
                            </div>
                        </template>

                        <template x-if="openModal === 'showFacts'">
                            <div>
                                <header class="modal-card-head">
                                    <p class="modal-card-title">Facts</p>
                                </header>
                                <section class="modal-card-body">
                                    <template x-if="selectedLinkOutput">
                                        <div class="mb-5">
                                            <p>Output: </p>
                                            <code x-text="selectedLinkOutput"></code>
                                        </div>
                                    </template>
                                    <template x-for="fact in selectedLinkFacts">
                                        <p class="highlight" x-text="fact"></p>
                                    </template>
                                    <p x-show="selectedLinkCommand">Command: <em x-text="selectedLinkCommand"></em></p>
                                </section>
                            </div>
                        </template>
                        <footer class="modal-card-foot">
                            <!--                    TODO when user clicks on add operation it should show on view screen-->
                            <!--                    TODO add tooltip for scheduling, user must set AM/PM along with numerical time value in order for schedule to work-->
                            <template x-if="openModal === 'addOperation'">
                                <button class="button is-primary is-small" x-on:click="handleStartOperation"
                                        x-text="schedule ? 'Schedule' : 'Start'"></button>
                            </template>
                            <template x-if="openModal === 'addCommand'">
                                <button class="button is-primary is-small"
                                        x-on:click="handleManualCommand">
                                    <!--                                TODO change save to add command? explore later-->
                                    Save
                                </button>
                            </template>
                            <template x-if="openModal === 'addLink'">
                                <div class="modal-results-close">
                                    <button class="button is-small is-primary" x-on:click="openModal = null">Close
                                    </button>
                                </div>
                            </template>
                            <template x-if="openModal !== 'addLink'">
                                <button class="button is-small" x-on:click="openModal = null">Cancel
                                </button>
                            </template>
                        </footer>
                    </div>
                </form>
            </div>
        </template>
    </div>
</div>

<script>
    const endpoint = '/api/v2/operations';
    const executorShells = {
        psh: 'PS >',
        cmd: '>',
        sh: '$'
    };
    const linkStatuses = {
        '0': 'success',
        '1': 'failure',
        '-2': 'remove',
        '-3': 'collect',
        '-4': 'untrusted',
        '-5': 'visible',
        '124': 'timeout'
    };

    // https://stackoverflow.com/questions/7641791/javascript-library-for-human-friendly-relative-date-formatting
    function getHumanFriendlyTime(date) {
        if (!date) return '';
        // Make a fuzzy time
        let delta = Math.round((+new Date - date) / 1000);

        let minute = 60,
            hour = minute * 60,
            day = hour * 24;

        let fuzzy;

        if (delta < 30) {
            fuzzy = 'just now';
        } else if (delta < minute) {
            fuzzy = delta + ' seconds ago';
        } else if (delta < 2 * minute) {
            fuzzy = 'a minute ago'
        } else if (delta < hour) {
            fuzzy = Math.floor(delta / minute) + ' minutes ago.';
        } else if (Math.floor(delta / hour) === 1) {
            fuzzy = '1 hour ago'
        } else if (delta < day) {
            fuzzy = Math.floor(delta / hour) + ' hours ago.';
        } else if (delta < day * 2) {
            fuzzy = 'yesterday';
        } else if (delta < day * 3) {
            fuzzy = '3 days ago'
        } else {
            let split = date.split('-')[0];
            let hDate = split[2];
            let hMonth = Number(split[1]);

            switch (hMonth) {
                case 0:
                    hMonth = 'Jan';
                    break;
                case 1:
                    hMonth = 'Feb';
                    break;
                case 2:
                    hMonth = 'Mar';
                    break;
                case 3:
                    hMonth = 'Apr';
                    break;
                case 4:
                    hMonth = 'May';
                    break;
                case 5:
                    hMonth = 'Jun';
                    break;
                case 6:
                    hMonth = 'Jul';
                    break;
                case 7:
                    hMonth = 'Aug';
                    break;
                case 8:
                    hMonth = 'Sep';
                    break;
                case 9:
                    hMonth = 'Oct';
                    break;
                case 10:
                    hMonth = 'Nov';
                    break;
                case 11:
                    hMonth = 'Dec';
                    break;
                default:
                    hMonth = '';
                    break;
            }

            fuzzy = hMonth + ' ' + hDate;
        }
        return fuzzy;
    }

    function alpineOperations() {
        return {
            agentGroups: `{{ groups | tojson }}`.toString().replace(/["\[\]]/g, '').split(','),
            selectedOperationID: null,
            selectedOperation: null,
            selectedAgentIndex: null,
            selectedLink: null,
            selectedLinkOutput: null,
            selectedLinkFacts: null,
            selectedLinkCommand: null,
            isAgentOutputSelected: false,
            openModal: null,
            openModalForm: {
                'basic': false,
                'autonomous': false,
                'stealth': false,
                'schedule': false
            },
            operations: [],
            startOperation: {
                index: "operations",
                name: "",
                group: "",
                adversary_id: "",
                auto_close: "0",
                state: "running",
                autonomous: "1",
                planner: "atomic",
                source: "basic",
                use_learning_parsers: "1",
                timeout: "30",
                obfuscator: "plain-text",
                jitter: "4/8",
                visibility: "50",
            },
            manualCommand: {
                index: "manual_command",
                agent: "",
                operation: "",
                executor: "",
                command: ""
            },
            potentialLink: {
                agent: "",
                tactic: "",
                technique: "",
            },
            tacticFiltersList: [],
            techniqueFiltersList: [],
            filteredLinksList: [],
            schedule: "",
            showLinkEditDropdown: null,
            editedCommand: null,

            get selectedAgent() {
                return this.selectedOperation?.host_group[this.selectedAgentIndex];
            },

            get selectedAgentExecutors() {
                if (this.selectedAgent) return this.selectedAgent.executors.map(e => executorShells[e]);
                else return [];
            },

            //
            // API CALLS
            //

            getOperations() {
                restRequest('GET', {}, (res) => {
                    this.operations = JSON.parse(res);
                }, endpoint);
            },

            getOperation() {
                if (this.selectedOperationID) {
                    restRequest('GET', {}, (res) => {
                        this.selectedOperation = JSON.parse(res);
                        console.log('NEW OP stat', this.selectedOperation.state)
                        // toast('Go to the GameBoard plugin to see if the blue team can detect your activities.', true);
                    }, endpoint + '/' + this.selectedOperationID);
                } else {
                    toast('Select a valid operation to view.');
                }
            },

            deleteOperation() {
                const operationName = this.selectedOperation.name;
                restRequest('DELETE', {'index': 'operations', 'id': this.selectedOperationID}, (res) => {
                    // TODO check this error
                    if (!res) toast('Error deleting operation: ', operationName);
                    else {
                        this.getOperations();
                        this.selectedOperation = null;
                        this.selectedOperationID = null;
                        toast('Deleted operation: ', operationName, true);
                    }
                })
            },

            getAgents() {
                restRequest('POST', {'index': 'agents'}, (data) => {
                    this.updateAgentGroups(JSON.parse(data));
                });
            },

            // TODO check with mock fact data
            getResults(linkID) {
                restRequest('POST', {'index': 'result', 'link_id': linkID}, (data) => {
                    if (data) {
                        data = JSON.parse(data);
                        this.selectedLinkOutput = b64DecodeUnicode(data.output);
                        if (data.link.facts) {
                            this.selectedLinkFacts = Array.from(data.link.facts, fact => fact.value.toString());
                            this.selectedLinkFacts = Array.from(new Set(this.selectedLinkFacts));
                            this.selectedLinkFacts.sort((a, b) => b.length - a.length);
                        }
                        this.selectedLinkCommand = b64DecodeUnicode(data.link.command);
                    } else {
                        this.selectedLinkOutput = null;
                        this.selectedLinkFacts = null;
                        this.selectedLinkCommand = null;
                    }
                });
            },

            handleStartOperation() {
                if (!this.validateJitter(this.startOperation.jitter)) return;
                if (!this.startOperation.name) {
                    toast('Error: Operation name field is empty.');
                } else if (this.schedule) {
                    const time = this.schedule.split(":");
                    restRequest('PUT', {
                        'index': 'schedule',
                        'operation': this.startOperation,
                        'schedule': {'hour': parseInt(time[0]), 'minute': parseInt(time[1])}
                    });
                    this.openModal = null;
                    toast('Scheduled operation ' + this.startOperation.name + "!", true);
                } else {
                    restRequest('PUT', this.startOperation, () => {
                        toast('Notice that you can pause or stop the operation at any time. Toggle into manual mode if you want full control or click potential links to add TTPs to the operation.', true);
                        // TODO if the v2 PUT request returns a new operation id, set this to the ID
                        // if not, then set it to latest item in this.operations[]
                        // this.selectedOperation = this.startOperation;
                        this.resetObject(this.startOperation);
                        this.getOperations();
                    });
                    toast('Started operation ' + this.startOperation.name + "!", true);
                    this.openModal = null;
                }
            },

            handleManualCommand() {
                if (!this.manualCommand.command) {
                    toast('Enter manual command.');
                    return;
                }
                this.manualCommand.agent = this.selectedAgent.paw;
                this.manualCommand.operation = this.selectedOperationID;
                this.manualCommand.executor = document.getElementById('manual-executor').selectedOptions[0].value;
                restRequest('PUT', this.manualCommand, (data) => {
                    data = JSON.parse(data);
                    this.openModal = null;
                    if (data['error']) toast('Error: ' + data['error']);
                    else {
                        toast('Added manual command.', true);
                        this.getOperation();
                        this.resetObject(this.manualCommand)
                    }
                })
            },

            getAgentLinks() {
                this.potentialLink.agent = this.selectedAgent;
                this.tacticFiltersList = [];
                this.techniqueFiltersList = [];
                this.potentialLink.agent.links.forEach((link) => {
                    this.tacticFiltersList.push(link.ability.tactic);
                    this.techniqueFiltersList.push(link.ability.technique_name);
                });
                this.tacticFiltersList = sortAlphabetically(this.tacticFiltersList);
                this.techniqueFiltersList = sortAlphabetically(this.techniqueFiltersList);
                this.filteredLinksList = this.potentialLink.agent.links;
            },

            addLink(link) {
                restRequest('PUT', {...link, index: "link"}, () => {
                    this.getOperations();
                    this.getAgents();
                });
            },

            updateOperationState(newState) {
                toast('Changing operation state to: ' + newState);
                restRequest('POST', {
                    'index': 'operation',
                    'op_id': this.selectedOperationID,
                    'state': newState
                }, () => this.getOperation());
            },

            updateOperationToggle() {
                console.log('SELECTED OP TOGGLE', this.selectedOperation.autonomous);
                restRequest('POST', {
                    'index': 'operation',
                    'op_id': this.selectedOperationID,
                    'autonomous': 'toggleMe'
                });
            },

            updateObfuscator(newObfuscator) {
                console.log('chosen obfusc', newObfuscator, this.selectedOperation.obfuscator)
                this.selectedOperation.obfuscator = newObfuscator;
                restRequest('POST', {
                    'index': 'operation',
                    'op_id': this.selectedOperationID,
                    'obfuscator': this.selectedOperation.obfuscator
                });
            },

            updateLinkState(linkID, status, command = null) {
                const data = {
                    'index': 'chain',
                    'link_id': linkID,
                    'status': status
                };
                if (command) {
                    data['command'] = command;
                }
                restRequest('POST', data, (data) => {
                        if (data['error']) {
                            toast('Error: ' + data['error']);
                            return;
                        }
                        this.getOperation();
                        toast('Updating link status to: ' + linkStatuses[status]);
                    }
                );
            },

            downloadInfo(formatType) {
                if (!this.selectedOperationID) {
                    toast('Select a valid operation to download.');
                } else {
                    console.log('agent output val', this.isAgentOutputSelected, Number(this.isAgentOutputSelected));
                    restRequest('POST', {
                        'index': 'operation_report',
                        'op_id': this.selectedOperationID,
                        'agent_output': Number(this.isAgentOutputSelected),
                        'format': formatType
                    }, (data) => {
                        data = JSON.parse(data);
                        this.createDownloadReport(data, this.selectedOperation.name + '_' + formatType);
                    })
                }
            },

            //
            // OBJECT MANIPULATION
            //

            createDownloadReport(data, fileName) {
                const dataURL = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                toast('Downloading report: ' + fileName);
                const elem = document.createElement('a')
                elem.setAttribute('href', dataURL);
                elem.setAttribute('download', fileName + '.json');
                elem.click();
            },

            resetObject(obj = {}) {
                for (const field in obj) {
                    if (field !== 'index') this.startOperation[field] = "";
                }
            },

            updateAgentGroups(agents) {
                if (agents) {
                    agents.forEach((agent) => {
                        if (!this.agentGroups.includes(agent.group)) this.agentGroups.push(agent.group);
                    })
                }
            },

            validateJitter(newValue = "") {
                if (!newValue.includes('/')) return false;
                let [jitterMin, jitterMax] = newValue.split("/");
                jitterMin = parseInt(jitterMin);
                jitterMax = parseInt(jitterMax);

                if (jitterMin < 0 || jitterMax < 0) {
                    toast('Error: Jitter ' + (!jitterMin ? 'MIN' : 'MAX') + ' must be valid.');
                    return false;
                }
                if (jitterMin >= jitterMax) {
                    toast('Error: Jitter MIN must be less than the jitter MAX.');
                    return false;
                }

                return true;
            },

            filterAbilities() {
                console.log('filterAbilities called', this.potentialLink);
                this.filteredLinksList = this.potentialLink.agent.links.filter((link) => {
                    let match = true;
                    if (this.potentialLink.tactic) match = this.potentialLink.tactic === link.ability.tactic;
                    if (this.potentialLink.technique) match = this.potentialLink.technique === link.ability.technique_name;
                    return match;
                })
            },
        }
    }
</script>

<style>
    .operation-menu-links {
        color: white;
        margin: 1rem 2em;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 5em;
        flex-flow: column wrap;
    }

    .operation-menu-links .readable-time {
        color: gray;
    }

    .operation-menu-links i {
        font-size: 4em;
        padding-bottom: 5px;
    }

    .operation-menu-links i span {
        position: relative;
        left: -35px;
        top: -7px;
        font-size: 0.5em;
        color: #8B0000;
    }

    .operation-menu-links i span:last-child {
        position: relative;
        left: -5px;
    }

    .operation-menu-links:hover {
        /*transform: none !important;*/
    }

    .modal-card {
        max-height: 90vh;
        overflow-y: scroll;
    }

    .column {
        margin: 0;
    }

    /*MODAL FORM STYLE*/
    .modal-form > div {
        width: 100%;
        display: flex;
        flex-flow: row wrap;
        justify-content: center;
    }

    .modal-form > div > label {
        width: 30%;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        font-size: 0.75rem;
    }

    .modal-form-group-header {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-form-group-header button {
        width: 100%;
        padding-left: 0;
        padding-right: 0;
        text-align: left;
    }

    .modal-form-group-header button.expanded span:first-child::after {
        margin-left: 0.2rem;
        content: "";
    }

    .modal-form-group-header button.collapsed span:first-child::after {
        margin-left: 0.2rem;
        content: "";
    }

    .modal-form-group-header button:hover {
        transform: none !important;
    }

    .modal-form-fields {
        width: 70%;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        flex-flow: row wrap;
    }

    .modal-form-fields input, .modal-form-fields select {
        margin: 0.75rem;
    }

    .modal-form-fields-columns {
        display: flex;
        flex-flow: row wrap;
        justify-content: space-between;
        align-items: center;
        margin-left: 0.75rem;
        width: 100%;
    }

    .modal-form-fields-columns .executor-selector {
        width: 10% !important;
        flex: none !important;
    }

    .modal-form-fields-columns .executor-command {
        width: 90%;
    }

    .modal-form-fields label {
        margin-right: 1rem;
        font-size: 0.75rem;
    }

    .modal-results ul {
        margin-left: 0;
    }

    .modal-results li {
        display: flex;
        justify-content: space-around;
        align-items: center;
        flex-flow: row wrap;
        list-style: none;
    }

    .modal-results li p {
        width: 85%;
        text-align: left;
        padding-left: 0.75rem;
    }

    .modal-results li button {
        width: 15%;
        display: flex;
    }

    .modal-results li:not(:last-child)::after {
        background-color: #262626;
        border: none;
        display: block;
        height: 2px;
        margin: 0.5rem 0;
        content: "";
    }

    .modal-results-close {
        display: flex;
        justify-content: center;
        width: 100%;
    }

    /*END MODAL FORM STYLE*/

    .modal-card code, .code {
        color: #ff8181;
        background-color: #262626;
    }

    /*TOGGLE STYLE*/
    /* toggle buttons */
    .toggleContainer {
        display: flex;
        align-items: center;
    }

    .toggleSwitch {
        position: relative;
        display: inline-block;
        width: 140px;
        height: 34px;
    }

    .toggleSwitch input {
        display: none;
    }

    .toggleSlider {
        border: 1px solid white;
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 34px;
    }

    .toggleSlider::before {
        position: absolute;
        content: "";
        height: 25px;
        width: 25px;
        bottom: 4px;
        background-color: white;
        transition: all 0.3s ease;
        left: 4px;
    }

    .toggle-off {
        background-color: black;
    }

    .toggle-on {
        background-color: green;
    }

    .toggle-slider-on,
    .toggle-slider-off {
        color: white;
        position: absolute;
        transform: translate(-50%, -50%);
        top: 50%;
        left: 50%;
        font-size: 10px;
        font-family: Verdana, sans-serif;
    }

    .toggle-on.toggleSlider.toggleSlider::before {
        transform: translatex(105px);
    }

    .toggle-off.toggleSlider.toggleSlider::before {
        transform: translatex(0px);
    }

    .toggleSlider.toggleSliderRound::before {
        border-radius: 50%;
    }

    /*END TOGGLE*/


    .log-container {
        /*background-color: black;*/
        border-radius: 5px;
        margin-top: 1rem;
        padding: 2rem 1.3rem 4rem;
        border-collapse: collapse;
    }

    .log-container table {
        /*background-color: black;*/
        background-color: inherit;
    }

    .log-container table tr th {
        font-weight: 400;
        font-size: 0.75rem;
        border-bottom: none;
        color: gray;
    }

    .log-container table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .log-container table tbody tr:active {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .button:active, .button.is-active, .button:focus, .button.is-focused {
        color: inherit;
    }

    button.is-larger {
        font-size: 2.1rem;
    }

    .linkActionsColumn button[disabled] {
        background-color: transparent;
    }

    button.no-style {
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    button.chip-select {
        border: 2px solid #8B0000;
        border-radius: 24px;
        color: white;
        padding: 5px 12px;
        cursor: pointer;
        margin: 0.75em 0.75em 0 0;
    }

    button.chip-select:hover {
        background-color: #8B0000;
        transform: none !important;
    }

    button.chip-select.selected {
        background-color: #8B0000;
    }

    button.no-style:hover {
        border: none;
        color: white;
        transform: scale(1.2);
    }

    i.facts {
        color: rgb(248, 193, 69);
    }

    i.no-facts {
        color: gray;
    }

    i.editCommand.collapsed::after {
        font-size: 5pt;
        content: "";
    }

    i.editCommand.expanded::after {
        font-size: 5pt;
        content: "";
    }

    i sub {
        font-family: sans-serif;
    }

    .controls-container button {
        margin: 0 2rem;
        padding: 0;
    }

    .log-container table tbody td {
        vertical-align: middle;
        border: none;
        height: 8em;
    }

    .log-container table th.header {
        border-bottom: none;
    }

    .log-container .decideColumn {
        color: gray;
        width: 120px;
        word-break: break-word;
        font-size: 0.75rem;
        text-align: center !important;
    }

    .log-container td.decideColumn {
        padding: 0 1em;
        display: flex;
        flex-flow: column wrap;
        justify-content: center;
    }
    table tbody td.linkStatusColumn {
        padding: 0;
        vertical-align: top;
    }

    table tbody td.linkActionsColumn {
        display: flex;
        align-items: center;
        flex-flow: row-reverse;
        padding-bottom: 0;
    }

    .editButtonContainer.selected {
        background-color: #2b2929;
        border-radius: 2px 2px 0;
        padding: 5px 0;
    }

    table tbody tr.linkEditCommandRow td:last-child {
        display: flex;
        justify-content: space-around;
        padding: 0;
        flex-flow: row;
        align-items: center;
        background-color: #2b2929;
        border-radius: 2px;
    }

    table tbody tr.linkEditCommandRow textarea {
        border-radius: 2px;
        line-height: 0.75rem;
        width: 10rem;
    }

    table tbody tr.linkEditCommandRow .linkEditControls {
        display: flex;
        flex-flow: row wrap;
        justify-content: flex-end;
        align-items: center;
    }

    /*gray timeline*/
    table tbody td span.linkStatus::before {
        width: 2px;
        height: 140px;
        background-color: #8B0000;
        content: "";
        display: inline-block;
        position: absolute;
        margin-left: 10px;
    }

    table tbody:last-child td span.linkStatus::before {
        height: 75px;
    }

    /*circle for event*/
    table tbody td span.linkStatus::after {
        position: relative;
        left: -5px;
        top: 50px;
        display: block;
        background: black;
        border-radius: 50%;
        height: 2em;
        width: 2em;
        content: "";
        box-shadow: 0 0 0 0.2em #555; /*queued*/
    }

    /*success*/
    table tbody td span.status-success::after {
        box-shadow: 0 0 0 0.2em #4a9;
    }

    /*failure*/
    table tbody td span.status-failure::after {
        box-shadow: 0 0 0 0.2em #c31;
    }

    /*removed*/
    table tbody td span.status-remove::after {
        box-shadow: 0 0 0 0.2em #a05195;
    }

    /*collected*/
    table tbody td span.status-collect::after {
        box-shadow: 0 0 0 0.2em #ffb000;
    }

    /*untrusted*/
    table tbody td span.status-untrusted::after {
        box-shadow: 0 0 0 0.2em white;
    }

    /*visible*/
    table tbody td span.status-visible::after {
        box-shadow: 0 0 0 0.2em #f012be;
    }

    /*timeout*/
    table tbody td span.status-timeout::after {
        box-shadow: 0 0 0 0.2em cornflowerblue;
    }
</style>
